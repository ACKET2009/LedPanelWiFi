# Настройка параметров в приложении

## Подключение к устройству

Итак, прошивка настроена, скомпилирована и загружена в микроконтроллер. Микроконтроллер запустился и в окне монитора порта вы видите сообщение, 
что точка доступа **PanelAP** создана со стандартным IP **192.168.4.1** и стандартным паролем 12341234.  

![Монитор порта](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p01.png)
               
Откройте в телефоне настройки WiFi подключений, найдите созданную сеть **PanelAP**  

![PanelAP-1](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p03.png)

Выберите сеть **PanelAP**, введите в поле пароля пароль **12341234** и нажмите кнопку **"Подключиться"**  

![PanelAP-2](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p02.png)

Ваш телефон подключился к точке доступа, созданной устройством  

![PanelAP-3](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p04.png)

Откройте в браузере на телефоне страничку по адресу **192.168.4.1**

![Приложение-1](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p05.png)

Web-приложение подключится к устройству. В верхней части экрана приложения вы увидите набор кнопок, позволяющих переключаться между страницами 
интерфейса Web-приложения. Перейдите на страницу **"Настройки"** (1), затем **"Сеть"** (2), и, наконец, **"Параметры сети"** (3).  

В секции **"Параметры сети"** укажите имя сети (SSID) и пароль доступа в сеть. В поле **"Текущий IP"** укажите желаемый адрес, 
который получит устройство в вашей сети. Обратите внимание, что IP адрес должен быть свободным, то есть не принадлежать какому-либо другому работающему в сети устройству.
При необходимости проверьте адреса вашей сети в настройках вашего роутера. Нажмите кнопку **"Применить"**. 

Устройство выполнит переподключение к сети с указанным адресом. Вы увидите соответствующие сообщения в мониторе порта.
На матрице устройства бегущей строкой отобразится адрес, полученный устройством.

После того, как настройки сети применены и устройство перезагрузилось - Web-приложение потеряет связь с устройством.  
Введите в адресной строке браузера IP-адрес, который вы назначели устройству на предыдущем шаге. Дождитесь загрузки страницы.
Впрочем, теперь, вероятнее всего вам будет удобнее открыть браузер по этому адресе на компьютере.  

Web-приложение в бораузере на телефоне и в браузере на компьютере обладают абсолютно одинаковым функционалом,
просто экран браузера на компьютере имеет больший размер, чем на экране телефона и пользоваться им удобнее.
Впрочем, это ваш выбор. Ниже будут использоваться иллюстрации с браузера, открытого на компьютере.  

![Приложение-2](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p08.png)

# Настройка устройства из приложения

Итак, соединение с устройством установлено, интерфейс управления возможностями устройства - доступен. 
Можно приступать к настройке остальных параметров, а также функций и эффектов.

В самой верхней части экрана Web-приложения находится информационная панель, отображающая имя вашего устройства, а также
переключатель, позволяющий выбрать светлую или темную тему интерфейса по вашему вкусу:  

![Приложение-9](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p11.png)

В верхней части экрана Web-приложения находится панель навигации по страничкам интерфейса

![Приложение-9](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-0.png)

#### Здесь:  
- **Эффекты** - настройка и управление *Эффектами*  
- **Тексты** - настройка и управление *Бегущей строкой*  
- **Часы** - настройка и управление *Часами*  
- **Будильник** - настройка и управление *Будильниками* с возможностью планирования расписания на неделю.  
- **Режимы** - настройка *Режимов, включаемых по времени*  
- **Рисование** - интерактивное рисование на матрице  
- **Игры** - четыре интерактивные игры  
- **Настройки** - настройки параметров системы  


## Настройки системы

Начнем, как бы это ни казалось странным, с конца - с последнего, но, пожалуй, самого важного пункта - **"Настройки"**.  
На странице наcтроек собраны элементы управления, позволяющие установить следующие параметры устройства:  

- **Матрица** - настройка типа матрицы и способа её подключения  
- **Группы** - настройка групповой работы устройств - [синхронизация между ними](https://github.com/vvip-68/LedPanelWiFi/wiki/Синхронизация-устройств)  
- **Сеть** - настройка подключения устройства к локальной сети, параметры работы у стройства в режиме точки доступа  
- **Погода** - настройка получения сведений о погоде с погодного сервера в Интернете  
- **Прочие** - прочие настройки системы, собранные на одной странице  

### Матрица

Этот раздел настроек позволяет указать какой тип матрицы используется в вашем устройстве, простая она или составная,
угол подключения и направления из угла и все прочие настройки, касающиеся конфигурации вашего устройства.

##### Простая матрица из одного сегмента

![Простая матрица](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-1.png)

Выберите вариант **"Использовать сегменты"** ***(1)***. В данном случае - сегмент всего один, размер сегмента совпадает с полной шириной и высотой матрицы.
Поэтому в разделе **"Сегмент матрицы"** в поле **"Ширина"** укажите количество светодиодов по ширине вашей матрицы ***(2)***, в поле 
**"Высота"** - количество светодиодов по высоте ***(3)***.  

Отметьте галочкой угол расположения первого светодиода вашей матрицы ***(4)***, куда подключается сигнальный провод вывода информации с пина *LED_PIN* микроконтроллера.
Далее выберите стрелочку ***(5)***, указывающую направление цепочки светодиодов из угла матрицы, то есть - в каком направлении следует второй, третий и так далее светодиод в цепочке.
Нажимайте на область в центре квадрата настройки подключения ***(6)***, чтобы переключить тип построения матрицы - ***зигзагом*** или ***параллельная***.  

В секции **"Сборная матрица"** укажите, что в **"Ширину"** ***(7)*** и **"Высоту"** ***(8)*** матрица состоит из одного единственного сегмента. 
По этой причине остальные настройки сегментов ***(9)*** можно не принимать во внимание и оставить такими как есть.

Завершите настройку, нажав на кнопку **"Применить"** ***(10)*** для сохранения выставленных настроек. Матрица перезагрузится и новые настройки вступят в силу.
На время перезапуска микроконтроллера соединение с устройством будет потеряно. Через некоторое время перезапуск контроллера с новыми настройками завершится и
соединение Web-приложение с устройством восстановится.

##### Составная матрица из сегментов одного типа и размера

![Составная матрица 1](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-2.png)

Выберите вариант **"Использовать сегменты"** ***(1)***. Для примера будем считать, что ваша матрица состоит из двух одинаковых сегментов ***16х16*** (общий размер матрицы ***32х16***).
То есть - матрица [составная](https://github.com/vvip-68/LedPanelWiFi/wiki/Сборная-матрица) (или ***сборная***, что одно и то же).
В разделе **"Сегмент матрицы"** в поле **"Ширина"** ***(2)*** укажите количество светодиодов по ширине **одного сегмента** вашей матрицы, в поле 
**"Высота"** ***(3)*** - количество светодиодов по высоте в ***одном сегменте*** вашей матрицы .  

Отметьте галочкой угол расположения первого светодиода сегмента матрицы ***(4)***, куда подключается сигнальный провод вывода информации с пина *LED_PIN* микроконтроллера.
Далее выберите стрелочку ***(5)***, указывающую направление цепочки светодиодов из угла сегмента, то есть - в каком направлении следует второй, третий и так далее светодиод в цепочке.
Нажимайте на область в центре квадрата настройки подключения ***(6)***, чтобы переключить тип построения матрицы - ***зигзагом*** или ***параллельная***.  

В секции **"Сборная матрица"** укажите, что в **"Ширину"** ***(7)*** полная матрица состоит из двух сегментов, в **"Высоту"** ***(8)*** - из одного единственного сегмента. 
Укажите в каком **углу** ***(9)*** сборной матрицы располагается ваш первый сегмент и в каком **направлении из угла** ***(10)*** размещены следующие сегменты. 
Для матрицы из двух сегментов этого достаточно. Однако, если сегментов матрицы несколько и они размещены в несколько строк (например матрица *32x32*, состоящая из
четырех сегментов *16х16*) - требуется указать как расположены сегменты по способу передачи сигнала - ***зигзагом*** или ***параллельно***. Для этого 
нажимайте на область в центре элемента выбора ***(11)***, пока стрелочки не примут соответствующее направление.

Завершите настройку, нажав на кнопку **"Применить"** ***(12)*** для сохранения выставленных настроек. Матрица перезагрузится и новые настройки вступят в силу.
На время перезапуска микроконтроллера соединение с устройством будет потеряно. Через некоторое время перезапуск контроллера с новыми настройками завершится и
соединение Web-приложение с устройством восстановится.

##### Составная матрица из сегментов разного типа и размера

![Составная матрица 2](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-3.png)

Выберите вариант **"Карта индексов"** ***(1)***. Как подготовить карту индексов обисано в этой [статье](https://github.com/vvip-68/LedPanelWiFi/wiki/Сборная-матрица,-состоящая-из-матриц-разного-типа-и-размера). 
Изучите ее. Выберите в комбобоксе ***(2)*** **карту индексов**, соответствующую размерам вашей сборной матрицы.
Если при составлении карты и [настройке параметров скетча](https://github.com/vvip-68/LedPanelWiFi/wiki/Настройка-скетча-для-вашего-устройства)
вы выбрали вариант размещения карты индексов *в скетче* - комбобокс будет содержать единственное значение, соответствующее размерам, заданным в карте.
Если карта индекса сохранена в файл и загружена в вайловую систему микроконтроллера - комбобокс будет содержать все найденный при запуске микроконтроллера
*карты индексов*. Выберите карту, соответствующую конструкции вашей сборной матрицы.

Еа этом настройка матрицы завершена. Остальные параметры на странице в этом варианте не имеют значения и недоступны к изменению.
Нажмите на кнопку **"Применить"** ***(3)*** для сохранения выставленных настроек. Матрица перезагрузится и новые настройки вступят в силу.
На время перезапуска микроконтроллера соединение с устройством будет потеряно. Через некоторое время перезапуск контроллера с новыми настройками завершится и
соединение Web-приложение с устройством восстановится.

### Группы

Если в прошивке при настройке параметров включена возможность [синхронизации устройств](https://github.com/vvip-68/LedPanelWiFi/wiki/Синхронизация-устройств) 
и работы в группе (параметр `USE_E131 1`)? вам доступен раздел настройки работы устройства в группе. Выберите значок настройки групповой работы (синхронизации).

![Группа-1](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-4-1.png)

В комбобоксе **"Режим работы"** ***(1)*** выберите желаемый режим работы:  
- **Автономный** - устройство работает самостоятельно, вне групп  
- **Источник (мастер)** - устройство является ведущим, изображение с его матрицы бкдет транслироваться на другие устройства группы.  
- **Приемник (ведомый)** - устройство будет получать изображение на матрицу с другого (ведущего) устройсьва в группе.  

![Группа-2](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-4-2.png)

В комбобоксе **"Тип синхронизации"** ***(2)*** укажите в каком порядке данные будут приходить к *ведомому* устройствe или 
в каком порядке *ведущее* устройство бкдет отправлять данные в сеть:  
- **Физический порядок** - "точки" светодиодов следуют в порядке их физического расположения в цепочке соединения диодов матрицы.  
- **Логический порядок** - "точки" светодиодов следуют в логическом порядке - по строкам, начиная с левого верхнего угла, далее вправо, далее вниз.  
- **Команды** - устройство синхронизируются на уровне команд.  

Различия в способах синхронизации, их плюсы и минусы описаны в [статье](https://github.com/vvip-68/LedPanelWiFi/wiki/Синхронизация-устройств).

![Группа-3](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-4-3.png)

В комбобоксе **"Группа синхронизации"** ***(3)*** укажите к какой группе принадлежит устройство.  

Принципы работы устройств в группах описаны в [статье](https://github.com/vvip-68/LedPanelWiFi/wiki/Синхронизация-устройств), изучите её.

![Группа-3](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-4-4.png)

Завершите настройку режимов сихронихации нажав на кнопку **"Применить"** ***(4)***.  

### Cеть

#### Настройка сети 

Перейдите в раздел настроек **сети** ***(1)***, параметров **сетевого подключения** ***(2)***.  

![Настройка сети](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-5-1.png)

В поле **"Имя сети"** ***(3)*** укажите ***идентификатор*** (***ssid***) вашей локальной сети.  
В поле **"Пароль"** ***(4)*** укажите ***пароль*** подключения к вашей сети.  
В поле **"IP адрес"** ***(5)*** укажите какой ***IP адрес*** должно получить ваше уустройство при подключении к сети.  

Убедитесь в настройках вашего роутера, список известных адресов сети, что указанный вами адрес не принадлежит никакому другому активному устройству,
во избежание конфликта сетевых адресов. При возникновении конфликта, если адрес уже кем-то занят, устройство нормально работать не будет.  

Завершите настройку подключения к сети, нажав на кнопку **"Применить"** ***(6)***. Микроконтроллер получит и сохранит переданные ему настройки, затем
перезагрузится, используя новые настройки. На время перезагрузки контроллера соединение с устройством будет потеряно, но затем восстановится, 
если после применения новых параметров устройство останется в том же сегменте локальной сети. 

#### Настройка точки доступа

Перейдите в раздел настроек **сети** ***(1)***, параметров **точки доступа** ***(2)***.  
 
![Настройка точки доступа](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-5-2.png)

Переключатель **"Создавать точку доступа"** ***(3)*** указывает устройству, нужно ли все время держать точку доступа активной, даже конгда устройство успешно подключилось к локальной сети.  

- Значение **выключено** - точка доступа создается только в том случае, если устройству не удалось подключиться к локальной сети.
  Сеть недоступна или указанные на предыдущем этаме настройки некорректны и не позволяют устройству присоединиться к сети.  

- Значение **"включено"** - точка доступа будет создаваться всегда вне зависимости от того произошло подключение к сети успешно илли нет.

В поле **Имя точки** укажите название точки доступа - как созданная устройством сеть будет видна в эфире. Значение по умолчанию - ***PanelAP***.  

В поле **Пароль** укажите пароль, необходимый при подключении к точке доступа. Значение по умолчанию - ***12341234***.  

Завершите настройку подключения к сети, нажав на кнопку **"Применить"** ***(6)***.  


### Погода

Если в [настройках прошивки](https://github.com/vvip-68/LedPanelWiFi/wiki/Настройка-скетча-для-вашего-устройства) при компиляции указана возможность 
получения текущей погоды  (параметр `USE_WEATHER 1`) - в этом разделе
задаются параметры запроса информации о погоде с соответствующих погодных серверов.  

![Настройка погоды](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-6-1.png)

Параметр **Сервер погоды** ***(1)*** определяет с какого погодного сервера устройство бкдет запрашивать информацию Доступные значения:  
- **Выключено** - информация о погоде не получается, отображение температуры в часах и в бегущей строке отключено.  
- **Yandex** - информация о погоде получается с погодного сервера ***Yandex.ru***  
- **OpenWeatherMap** - информация о погоде получается с погодного сервера ***OpenWeatherMap.com***  

В состав информации, получаемой с погодного сервера, кроме текущей температуры также получается время наступления ***рассвета*** и ***заката*** для возможности работы специальных 
["Режимов по времени"](https://github.com/vvip-68/LedPanelWiFi/wiki/Настройка-параметров-в-приложении#Настройки-режимов-по-времени) - 
**Рассвет** и **Закат**.  

- **"Код региона Yandex"** ***(2)*** - задает код города (села, метеостанции) для которого запрашивается информация с сервера погоды ***Yandex***.  
- **"Код региона OpenWeatherMap"** ***(3)*** - задает код города (села, метеостанции), для которого запрашивается информация с сервера погоды ***OpenWeatherMap***.  

Подробнее о настройках погоды читайте в [этой статье](https://github.com/vvip-68/LedPanelWiFi/wiki/Настройка-получения-информации-о-погоде)  

- **"Интервал обновления"** ***(4)*** - задаёт с какой периодичностью (в минутах) будет обновляться информация о текущей температуре с выбранного сервера погоды.  

Завершите настройку подключения к сети, нажав на кнопку **"Применить"** ***(6)***.  

### Прочие

В разделе **"Прочие"** собраны разнородные настройки, управляющие прочими аспектами работы устройства.  

![Настройка погоды](https://github.com/vvip-68/LedPanelWiFi/blob/main/wiki/Tune/p12-7-1.png)

#### Лимит по току

- Значение указанное в поле **"Лимит по току"** позволяет программным образом ограничить максимальную яркость светодиодов и уберечь блок питания от срабатывания защиты
  или выхода из строя, когда установленный уровень яркости светодиодов приводит к повышенному потреблению тока, которое используемый источник питания обеспечить не в состоянии. 
  Значение указывается в миллиамперах. Рекомендуется устанавливать ограничение по току процентов на 20 меньше максимального паспортного тока вашего источника питания.  

  При установке параметра **"Лимит по току"** учитывайте насколько хорошо выполнен теплоотвод от ленты. Светящиеся на полной яркости светодиоды выделяют довольно много тепла, 
  которое требуется отводить от ленты. При недостаточном отводе депла диоды будут перегреваться, что сократит срок их службы или вовсе выведет из строя.  

  Значение **0** в поле **"Лимит по току"** отключает программный контроль за потреблением тока матрицей. 

  После ввода в поле ограничения по току нажмите на кнопку **"Применить"** в этой секции, чтобы настройки были сохранены и применены в устройстве.  

#### Резервная копия настроек

Позволяет сохранить все выполненные настройки во внутренней файловой системе микроконтроллера или на подключенной SD-карте, если прошивка перед компиляцией была сконфигурирована
для работы с SD-картой ```USE_SD 1``` и карта вставлена в соответствующий модуль устройства.  

В резервной копии сохраняются параметры, заданные как на этой страничке приложения, так и на других - *настройки эффектов*, *настройки часов*, *будильников*, *режимов по времени* и т.д.
Рекомендуется выполнить сохранение текущих настроек устройства после завершения всего комплекса работ по настройке.  

Если SD-карта доступна - вы видите кнопку сохранения резервной копии настроек на подключенной ***SD-карте***.  
Если SD-карта отсутствует - резервная копия настроек может быть сохранена только во ***внутренней памяти*** микроконтроллера, в его файловой сситеме.

Нажмите на кнопку сохранения настроек в выбранном хранилище **FS** (*в файловой системе*) или **SD** (*на SD-карте*)  

После успешного сохранения настроек станет доступна кнопка ***загрузки"*** сохраненных настроек из хранилища **FS**, 
если файл сохраненных настроек найден *в файловой системе* или **SD**, если файл сохраненных нестроек найден *на SD-карте*.  
 
Нажатие этой кнопки загрузит настройки из файла ***eeprom.bin***, размещенном в указанном хранилище.
После успешной загрузки сохраненных настроек устройство будет автоматически перезагружено для применения считанных параметров.

*Примечание* - восстановление сохраненных настроек возможно только в случае совпадения кода идентификатора прошивки `EEPROM_OK`,
который может измениться при обновлении версии прошивки в случае изменения расположения хранения параметров в области постоянной памяти микроконтроллера.  

#### Конец

На этом описания настройки ***"системных"*** параметров устройства завершено.

Управление устройством, настройки эффектов, часов, будильников, текстов бегущей строки описано в следующей [статье](https://github.com/vvip-68/LedPanelWiFi/wiki/Управление-приложением)


